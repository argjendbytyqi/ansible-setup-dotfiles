---
- name: Ensure facts are gathered
  ansible.builtin.setup:

- name: Resolve architecture
  ansible.builtin.set_fact:
    tool_arch: "{{ tool_arch_map[ansible_facts['architecture']] | default('amd64') }}"

# -------------------------------------------------
# Detect existing binary (PATH-aware)
# -------------------------------------------------
- name: Check if {{ tool_name }} already installed
  ansible.builtin.command: "command -v {{ tool_binary }}"
  register: tool_bin
  changed_when: false
  failed_when: false

- name: Decide if install is needed
  ansible.builtin.set_fact:
    install_needed: "{{ tool_bin.rc != 0 }}"

# -------------------------------------------------
# Stop early if already installed
# -------------------------------------------------
- name: Skip {{ tool_name }} install (already present)
  ansible.builtin.debug:
    msg: "âœ… {{ tool_name }} already installed, skipping download"
  when: not install_needed

# -------------------------------------------------
# Resolve version
# -------------------------------------------------
- name: Get latest GitHub release
  ansible.builtin.uri:
    url: "https://api.github.com/repos/{{ tool_repo }}/releases/latest"
    return_content: true
  register: gh_release
  when:
    - install_needed
    - tool_version | length == 0

- name: Set effective version
  ansible.builtin.set_fact:
    tool_version_effective: "{{ tool_version if tool_version | length > 0 else gh_release.json.tag_name }}"
  when: install_needed

# -------------------------------------------------
# Resolve asset name (THIS IS THE KEY FIX)
# -------------------------------------------------
- name: Set asset name (archive)
  ansible.builtin.set_fact:
    tool_asset_effective: "{{ tool_asset_template | replace('{{arch}}', tool_arch) }}"
  when:
    - install_needed
    - tool_archive | bool

- name: Set asset name (raw binary)
  ansible.builtin.set_fact:
    tool_asset_effective: "{{ tool_binary }}_linux_{{ tool_arch }}"
  when:
    - install_needed
    - not tool_archive | bool

# -------------------------------------------------
# Download
# -------------------------------------------------
- name: Download {{ tool_name }}
  ansible.builtin.get_url:
    url: "https://github.com/{{ tool_repo }}/releases/download/{{ tool_version_effective }}/{{ tool_asset_effective }}"
    dest: "/tmp/{{ tool_asset_effective }}"
    mode: "0644"
  when: install_needed

# -------------------------------------------------
# Install (archive)
# -------------------------------------------------
- name: Extract {{ tool_name }} archive
  ansible.builtin.unarchive:
    src: "/tmp/{{ tool_asset_effective }}"
    dest: "/tmp/{{ tool_name }}"
    remote_src: true
  when:
    - install_needed
    - tool_archive | bool

- name: Install {{ tool_name }} binary from archive
  ansible.builtin.copy:
    src: "/tmp/{{ tool_name }}/{{ tool_archive_bin_path }}"
    dest: "{{ tool_install_path }}/{{ tool_binary }}"
    mode: "0755"
    remote_src: true
  become: true
  when:
    - install_needed
    - tool_archive | bool

# -------------------------------------------------
# Install (raw binary)
# -------------------------------------------------
- name: Install {{ tool_name }} raw binary
  ansible.builtin.copy:
    src: "/tmp/{{ tool_asset_effective }}"
    dest: "{{ tool_install_path }}/{{ tool_binary }}"
    mode: "0755"
    remote_src: true
  become: true
  when:
    - install_needed
    - not tool_archive | bool

# -------------------------------------------------
# Cleanup
# -------------------------------------------------
- name: Cleanup {{ tool_name }} temp files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/tmp/{{ tool_asset_effective }}"
    - "/tmp/{{ tool_name }}"
  when: install_needed
